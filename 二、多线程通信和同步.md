# äºŒã€å¤šçº¿ç¨‹é€šä¿¡å’ŒåŒæ­¥

## (ä¸€) å¤šçº¿ç¨‹çŠ¶æ€

### 1. çº¿ç¨‹çŠ¶æ€

>- åˆå§‹åŒ– ( `Init` ) : è¯¥çº¿ç¨‹æ­£åœ¨è¢«åˆ›å»º
>- å°±ç»ª ( `Ready` ) : è¯¥çº¿ç¨‹åœ¨å°±ç»ªåˆ—è¡¨ä¸­ , ç­‰å¾… CPU è°ƒåº¦
>- è¿è¡Œ ( `Running` ) : è¯¥çº¿ç¨‹æ­£åœ¨è¿è¡Œ
>- é˜»å¡ž ( `Blocked` ) : è¯¥çº¿ç¨‹è¢«é˜»å¡žæŒ‚èµ·
>   - `Blocked` çŠ¶æ€åŒ…æ‹¬ :  `pend` (é”ã€ äº‹ä»¶ã€ä¿¡å·é‡ç­‰é˜»å¡ž)ã€
>   `suspend`ï¼ˆä¸»åŠ¨ `pend`ï¼‰ã€`delay` (å»¶æ—¶é˜»å¡ž)ã€ `pendtime` (å› ä¸ºé”ã€äº‹ä»¶ã€ä¿¡å·é‡æ—¶é—´ç­‰è¶…æ—¶ç­‰å¾…)
>- é€€å‡º (`Exit`) : è¯¥çº¿ç¨‹è¿è¡Œç»“æŸ , ç­‰å¾…çˆ¶çº¿ç¨‹å›žæ”¶å…¶æŽ§åˆ¶å—èµ„æº
>
><img src="äºŒã€å¤šçº¿ç¨‹é€šä¿¡å’ŒåŒæ­¥.assets/image-20230725143410482.png" alt="image-20230725143410482" />

### 2. ç«žäº‰çŠ¶æ€ (Race Condition) å’Œ ä¸´ç•ŒåŒº (Critical Section)

>- ç«žäº‰çŠ¶æ€ (Race Condition) : å¤šçº¿ç¨‹åŒæ—¶è¯»å†™å…±äº«æ•°æ®
>- ä¸´ç•ŒåŒº (Critical Section) : è¯»å†™å…±äº«æ•°æ®çš„ä»£ç ç‰‡æ®µ
>- é¿å…ç«žäº‰çŠ¶æ€ç­–ç•¥ , å¯¹ä¸´ç•ŒåŒºè¿›è¡Œä¿æŠ¤ , åŒæ—¶åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è¿›å…¥ä¸´ç•ŒåŒº

## (äºŒ) äº’æ–¥ä½“å’Œé” `mutex`

### 1. äº’æ–¥é”`mutex`

>- ä¸ç”¨é”çš„æƒ…å†µæ¼”ç¤º
>- æœŸæœ›è¾“å‡ºä¸€æ•´æ®µå†…å®¹
>- `lock()` å’Œ `try_lock()`
>- `unlock()`
>
>[å®žéªŒå‚è€ƒä»£ç ](https://github.com/WONGZEONJYU/stu_cpp_thread/tree/main/106thread_mutex)

#### (1) å®žéªŒä¸€ : ä¸åŠ é”çš„æƒ…å†µ

><img src="äºŒã€å¤šçº¿ç¨‹é€šä¿¡å’ŒåŒæ­¥.assets/image-20230725143724741.png" alt="image-20230725143724741" />
>
><img src="äºŒã€å¤šçº¿ç¨‹é€šä¿¡å’ŒåŒæ­¥.assets/image-20230725143735107.png" alt="image-20230725143735107" />
>
>```tex
>ðŸ“èµ„æºç«žäº‰å¯¼è‡´è¾“å‡ºæ··ä¹±
>```

#### (2) å®žéªŒäºŒ : åŠ é”çš„æƒ…å†µ

><img src="äºŒã€å¤šçº¿ç¨‹é€šä¿¡å’ŒåŒæ­¥.assets/image-20230725144143901.png" alt="image-20230725144143901" />
>
><img src="äºŒã€å¤šçº¿ç¨‹é€šä¿¡å’ŒåŒæ­¥.assets/image-20230725144149799.png" alt="image-20230725144149799" />

#### (3) å®žéªŒä¸‰ : ä¸é˜»å¡žå°è¯•èŽ·å–é”

><img src="äºŒã€å¤šçº¿ç¨‹é€šä¿¡å’ŒåŒæ­¥.assets/image-20230725144608251.png" alt="image-20230725144608251" />
>
><img src="äºŒã€å¤šçº¿ç¨‹é€šä¿¡å’ŒåŒæ­¥.assets/image-20230725144842486.png" alt="image-20230725144842486" />
>
><img src="äºŒã€å¤šçº¿ç¨‹é€šä¿¡å’ŒåŒæ­¥.assets/image-20230725144851355.png" alt="image-20230725144851355" />

### 2. äº’æ–¥é”çš„å‘ : çº¿ç¨‹æŠ¢å ä¸åˆ°èµ„æº

><img src="äºŒã€å¤šçº¿ç¨‹é€šä¿¡å’ŒåŒæ­¥.assets/image-20230725144918844.png" alt="image-20230725144918844" />
>
><img src="äºŒã€å¤šçº¿ç¨‹é€šä¿¡å’ŒåŒæ­¥.assets/image-20230725145059452.png" alt="image-20230725145059452" />
>
>```
>âš ï¸è¡¥å……: é”æœ‰å¯èƒ½ä¼šè¢«åˆ«çš„çº¿ç¨‹èŽ·å–åˆ°,ä½†æ˜¯ç”±äºŽçº¿ç¨‹æ— æ³•é¢„æµ‹,æ‰€ä»¥å½“å‰ç»“æžœæ²¡æ˜¾ç¤ºåˆ°,å¹¶ä¸ä»£è¡¨ä¸ä¼šè¢«åˆ«çš„çº¿ç¨‹èŽ·å–åˆ°ã€‚åœ¨ä¸Šé¢çš„ç»“æžœæ˜¾ç¤º,ä¸´ç•Œèµ„æºè¢«2å·çº¿ç¨‹å ç”¨ç€ã€‚
>```

### 3.äº’æ–¥é”çš„å‘çš„è§£å†³åŠžæ³• (å¹¶éžå”¯ä¸€)

><img src="äºŒã€å¤šçº¿ç¨‹é€šä¿¡å’ŒåŒæ­¥.assets/image-20230725145454739.png" alt="image-20230725145454739" />
>
><img src="äºŒã€å¤šçº¿ç¨‹é€šä¿¡å’ŒåŒæ­¥.assets/image-20230725150401673.png" alt="image-20230725150401673" />

### 4. è¶…æ—¶é”åº”ç”¨ `timed_mutex` ( é¿å…é•¿æ—¶é—´æ­»é” )

>å¯ä»¥è®°å½•é”èŽ·å–æƒ…å†µ , å¤šæ¬¡è¶…æ—¶ , å¯ä»¥è®°å½•æ—¥å¿— , èŽ·å–é”™è¯¯æƒ…å†µ
>
><img src="äºŒã€å¤šçº¿ç¨‹é€šä¿¡å’ŒåŒæ­¥.assets/image-20230725150825686.png" alt="image-20230725150825686" />
>
><img src="äºŒã€å¤šçº¿ç¨‹é€šä¿¡å’ŒåŒæ­¥.assets/image-20230725150835741.png" alt="image-20230725150835741" />

### 5. é€’å½’é”(å¯é‡å…¥) `recursive_mutex` å’Œ `recursive_timed_mutex` ç”¨äºŽä¸šåŠ¡ç»„åˆ

>- åŒä¸€ä¸ªçº¿ç¨‹ä¸­çš„åŒä¸€æŠŠé”å¯ä»¥é”å¤šæ¬¡ , é¿å…äº†ä¸€äº›ä¸å¿…è¦çš„æ­»é”
>- ç»„åˆä¸šåŠ¡ç”¨åˆ°åŒä¸€ä¸ªé”

#### (1) å®žéªŒä¸€ : ä½¿ç”¨é€’å½’é”

><img src="äºŒã€å¤šçº¿ç¨‹é€šä¿¡å’ŒåŒæ­¥.assets/image-20230725151100909.png" alt="image-20230725151100909" />
>
><img src="äºŒã€å¤šçº¿ç¨‹é€šä¿¡å’ŒåŒæ­¥.assets/image-20230725151108474.png" alt="image-20230725151108474" />

#### (2) å®žéªŒäºŒ : ä½¿ç”¨æ™®é€šé” , $\color{red}{ç¨‹åºç›´æŽ¥å®•æŽ‰}$

><img src="äºŒã€å¤šçº¿ç¨‹é€šä¿¡å’ŒåŒæ­¥.assets/image-20230725151430882.png" alt="image-20230725151430882" />
>
><img src="äºŒã€å¤šçº¿ç¨‹é€šä¿¡å’ŒåŒæ­¥.assets/image-20230725151436838.png" alt="image-20230725151436838" />
>
>```tex
>ðŸ“–åœ¨å·¥ç¨‹é¡¹ç›®ä¸­éš¾å…ä¼šå‡ºçŽ°è°ƒç”¨å¤šæ¬¡é”,å¦‚æžœä½¿ç”¨æ™®é€šé”,åˆæ²¡æœ‰è¿›è¡Œç‰¹æ®Šå¤„ç†çš„è¯,ç¨‹åºç›´æŽ¥å®•æŽ‰,åœ¨c++11ä»¥ä¸Šç‰ˆæœ¬æä¾›äº†é€’å½’é”,ä¸éœ€è¦ç¨‹åºå‘˜è‡ªå·±åŽ»è¿›è¡Œç‰¹æ®Šå¤„ç†
>```

### 6. å…±äº«é” `shared_mutex`

>- c++14 å…±äº«è¶…æ—¶äº’æ–¥é” `shared_timed_mutex`
>- c++17 å…±äº«äº’æ–¥ `shared_mutex`
>- å¦‚æžœåªæœ‰å†™æ—¶éœ€è¦äº’æ–¥ , è¯»å–æ—¶ä¸éœ€è¦ , ç”¨æ™®é€šçš„é”çš„è¯å¦‚ä½•åš?
>- æŒ‰ç…§å¦‚ä¸‹ä»£ç  , è¯»å–åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è¿›å…¥ , åœ¨å¾ˆå¤šä¸šåŠ¡åœºæ™¯ä¸­ , æ²¡æœ‰å……åˆ†åˆ©ç”¨ cpu èµ„æº
>
><img src="äºŒã€å¤šçº¿ç¨‹é€šä¿¡å’ŒåŒæ­¥.assets/image-20230725151946275.png" alt="image-20230725151946275" />
>
>```
>ðŸ“–lock_shared()åˆç§°è¯»é”
>lock()åˆç§°å†™é”
>
>lock_shared()å¯ä»¥è¢«å¤šä¸ªçº¿ç¨‹èŽ·å–åˆ°é”
>lock()åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹èŽ·å–åˆ°é”,å…¶ä»–çº¿ç¨‹è°ƒç”¨lock()ä¼šè¢«é˜»å¡ž
>
>lock_shared()èŽ·å–åˆ°é”ä¹‹åŽ,æ‰€æœ‰çº¿ç¨‹çš„lock()è¢«é˜»å¡ž
>lock()èŽ·å–åˆ°é”ä¹‹åŽ,æ‰€æœ‰çº¿ç¨‹çš„lock_shared()å’Œlock()éƒ½ä¼šè¢«é˜»å¡ž
>
>```
>
>[shared_mutexå…±äº«é”å‚è€ƒä»£ç ](https://github.com/WONGZEONJYU/stu_cpp_thread/tree/main/107thread_shared)
>
><img src="äºŒã€å¤šçº¿ç¨‹é€šä¿¡å’ŒåŒæ­¥.assets/image-20230725153516211.png" alt="image-20230725153516211" />
>
><img src="äºŒã€å¤šçº¿ç¨‹é€šä¿¡å’ŒåŒæ­¥.assets/image-20230725153524515.png" alt="image-20230725153524515" />

## (ä¸‰) åˆ©ç”¨æ ˆç‰¹æ€§è‡ªåŠ¨é‡Šæ”¾é”RAII

### 1. ä»€ä¹ˆæ˜¯RAII , æ‰‹åŠ¨ä»£ç å®žçŽ°

>RAIIï¼ˆResource Acquisition Is Initializationï¼‰c++ä¹‹çˆ¶Bjarne Stroustrupæå‡º;
>ä½¿ç”¨å±€éƒ¨å¯¹è±¡æ¥ç®¡ç†èµ„æºçš„æŠ€æœ¯ç§°ä¸ºèµ„æºèŽ·å–å³åˆå§‹åŒ–ï¼›å®ƒçš„ç”Ÿå‘½å‘¨æœŸæ˜¯ç”±æ“ä½œç³»ç»Ÿæ¥ç®¡ç†çš„ï¼Œ
>æ— éœ€äººå·¥ä»‹å…¥ï¼› èµ„æºçš„é”€æ¯å®¹æ˜“å¿˜è®°ï¼Œé€ æˆæ­»é”æˆ–å†…å­˜æ³„æ¼ã€‚
>
>[RAIIå®žéªŒå‚è€ƒä»£ç ](https://github.com/WONGZEONJYU/stu_cpp_thread/tree/main/108thread_RAII)

#### (1) å®žéªŒä¸€ : æ‰‹åŠ¨å®žçŽ° RAII ç®¡ç† mutex èµ„æº

><img src="äºŒã€å¤šçº¿ç¨‹é€šä¿¡å’ŒåŒæ­¥.assets/image-20230725154715041.png" alt="image-20230725154715041" />
>
><img src="äºŒã€å¤šçº¿ç¨‹é€šä¿¡å’ŒåŒæ­¥.assets/image-20230725154755052.png" alt="image-20230725154755052" />

### 2. c++11æ”¯æŒçš„RAIIç®¡ç†äº’æ–¥èµ„æº `lock_guard`

>- C++11 å®žçŽ°ä¸¥æ ¼åŸºäºŽä½œç”¨åŸŸçš„äº’æ–¥ä½“æ‰€æœ‰æƒåŒ…è£…å™¨
>- `adopt_lock` C++11 ç±»åž‹ä¸º `adopt_lock_t` , å‡è®¾è°ƒç”¨æ–¹å·²æ‹¥æœ‰äº’æ–¥çš„æ‰€æœ‰æƒ
>- é€šè¿‡ `{ }` æŽ§åˆ¶é”çš„ä¸´ç•ŒåŒº

#### (1) å®žéªŒä¸€ : 

><img src="äºŒã€å¤šçº¿ç¨‹é€šä¿¡å’ŒåŒæ­¥.assets/image-20230725155039892.png" alt="image-20230725155039892" />
>
><img src="äºŒã€å¤šçº¿ç¨‹é€šä¿¡å’ŒåŒæ­¥.assets/image-20230725155054768.png" alt="image-20230725155054768" />

#### (2) å®žéªŒäºŒ : åŒä¸€ä¸ªçº¿ç¨‹é”ä¸¤æ¬¡ , ç¨‹åºæŠ›å‡ºå¼‚å¸¸

><img src="äºŒã€å¤šçº¿ç¨‹é€šä¿¡å’ŒåŒæ­¥.assets/image-20230725155223611.png" alt="image-20230725155223611" />
>
><img src="äºŒã€å¤šçº¿ç¨‹é€šä¿¡å’ŒåŒæ­¥.assets/image-20230725155227008.png" alt="image-20230725155227008" />

#### (3) å®žéªŒä¸‰ : æ­£å¸¸æƒ…å†µ (ç¨‹åºä¸ä¼šè¢«é”ä¸¤æ¬¡)

><img src="äºŒã€å¤šçº¿ç¨‹é€šä¿¡å’ŒåŒæ­¥.assets/image-20230725155328878.png" alt="image-20230725155328878" />
>
><img src="äºŒã€å¤šçº¿ç¨‹é€šä¿¡å’ŒåŒæ­¥.assets/image-20230725155334903.png" alt="image-20230725155334903" />

### 3. c++11å¼•å…¥`unique_lock` 

>- `unique_lock` C++11 å®žçŽ° **$\color{red}{å¯ç§»åŠ¨}$** çš„äº’æ–¥ä½“æ‰€æœ‰æƒåŒ…è£…å™¨
>- æ”¯æŒ **$\color{red}{ä¸´æ—¶é‡Šæ”¾é”}$** `unlock()`
>- æ”¯æŒ `std::adopt_lock` **$\color{red}{(å·²ç»æ‹¥æœ‰é” , ä¸åŠ é” , å‡ºæ ˆåŒºä¼šé‡Šæ”¾)}$**
>- æ”¯æŒ `std::defer_lock` **$\color{red}{(å»¶åŽæ‹¥æœ‰ , ä¸åŠ é” , å‡ºæ ˆåŒºä¸é‡Šæ”¾)}$**
>- æ”¯æŒ `std::try_to_lock` å°è¯•èŽ·å¾—äº’æ–¥çš„æ‰€æœ‰æƒè€Œ **$\color{red}{ä¸é˜»å¡ž}$**  , èŽ·å–å¤±è´¥é€€å‡ºæ ˆåŒºä¸ä¼šé‡Šæ”¾ , é€šè¿‡ `owns_lock()` å‡½æ•°åˆ¤æ–­
>- æ”¯æŒè¶…æ—¶å‚æ•° , è¶…æ—¶ä¸æ‹¥æœ‰é”
>
>```c++
>/*unique_lockéƒ¨åˆ†æºç */
>
> unique_lock(unique_lock&& _Other) noexcept : _Pmtx(_Other._Pmtx), _Owns(_Other._Owns) {
>        _Other._Pmtx = nullptr;
>        _Other._Owns = false;
>    }
>
>unique_lock& operator=(unique_lock&& _Other) noexcept /* strengthened */ {
>        if (this != _STD addressof(_Other)) {
>            if (_Owns) {
>                _Pmtx->unlock();
>            }
>
>            _Pmtx        = _Other._Pmtx;
>            _Owns        = _Other._Owns;
>            _Other._Pmtx = nullptr;
>            _Other._Owns = false;
>        }
>        return *this;
>    }
>
>~unique_lock() noexcept {
>        if (_Owns) {
>            _Pmtx->unlock();
>        }
>    }
>
>unique_lock(const unique_lock&)            = delete;
>unique_lock& operator=(const unique_lock&) = delete;
>```
>
>[RAII_unique_lockå‚è€ƒä»£ç ](https://github.com/WONGZEONJYU/stu_cpp_thread/tree/main/108thread_RAII)
>
><img src="äºŒã€å¤šçº¿ç¨‹é€šä¿¡å’ŒåŒæ­¥.assets/image-20230725160238700.png" alt="image-20230725160238700" />

### 4. C++14å¼•å…¥`shared_lock` 

>- `shared_lock` C++14 å®žçŽ° **$\color{red}{å¯ç§»åŠ¨}$** çš„ **$\color{SkyBlue}{å…±äº«äº’æ–¥ä½“}$** æ‰€æœ‰æƒå°è£…å™¨
>- ä¸Ž`unique_lock` æœ‰ç€ç›¸ä¼¼åŠŸèƒ½
>
><img src="äºŒã€å¤šçº¿ç¨‹é€šä¿¡å’ŒåŒæ­¥.assets/image-20230725160641971.png" alt="image-20230725160641971" />

### 5. C++17å¼•å…¥`scoped_lock` 

>`scoped_lock` C++17 ç”¨äºŽå¤šä¸ªäº’æ–¥ä½“çš„å…æ­»é” RAII å°è£…å™¨ ç±»ä¼¼ `lock()`
>
>[lock()ä»‹ç»ä¸Žä½¿ç”¨æ–¹æ³•](https://en.cppreference.com/w/cpp/thread/lock)

#### (1) å®žéªŒä¸€ : æ¼”ç¤ºæ­»é”

><img src="äºŒã€å¤šçº¿ç¨‹é€šä¿¡å’ŒåŒæ­¥.assets/image-20230725162001393.png" alt="image-20230725162001393" />
>
><img src="äºŒã€å¤šçº¿ç¨‹é€šä¿¡å’ŒåŒæ­¥.assets/image-20230725162008172.png" alt="image-20230725162008172" />

#### (2) å®žéªŒäºŒ : å¦‚ä½•é˜²æ­¢æ­»é”

><img src="äºŒã€å¤šçº¿ç¨‹é€šä¿¡å’ŒåŒæ­¥.assets/image-20230725162033662.png" alt="image-20230725162033662" />
>
><img src="äºŒã€å¤šçº¿ç¨‹é€šä¿¡å’ŒåŒæ­¥.assets/image-20230725162630319.png" alt="image-20230725162630319" />

6.ç»¼åˆæ¡ˆä¾‹ä¸€ : ä½¿ç”¨äº’æ–¥é” ( `mutex` ) + ( `list` )æ¨¡æ‹Ÿçº¿ç¨‹é€šä¿¡

>- å°è£…çº¿ç¨‹åŸºç±» `XThread` æŽ§åˆ¶çº¿ç¨‹å¯åŠ¨å’Œåœæ­¢
>- æ¨¡æ‹Ÿæ¶ˆæ¯æœåŠ¡å™¨çº¿ç¨‹ æŽ¥æ”¶å­—ç¬¦ä¸²æ¶ˆæ¯ï¼Œå¹¶æ¨¡æ‹Ÿå¤„ç†
>- é€šè¿‡ `unique_lock` å’Œ `mutex` äº’æ–¥è®¿é—® `list<string>` æ¶ˆæ¯é˜Ÿåˆ—
>- ä¸»çº¿ç¨‹å®šæ—¶å‘é€æ¶ˆæ¯ç»™å­çº¿ç¨‹
>
>[æ¡ˆä¾‹ä¸€å‚è€ƒä»£ç ](https://github.com/WONGZEONJYU/stu_cpp_thread/tree/main/109thread_msg_server)
>
><img src="äºŒã€å¤šçº¿ç¨‹é€šä¿¡å’ŒåŒæ­¥.assets/image-20230725163440584.png" alt="image-20230725163440584" />
>
><img src="äºŒã€å¤šçº¿ç¨‹é€šä¿¡å’ŒåŒæ­¥.assets/image-20230725163502440.png" alt="image-20230725163502440" />

