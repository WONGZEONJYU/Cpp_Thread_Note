# å¤šçº¿ç¨‹é€šä¿¡å’ŒåŒæ­¥

## (ä¸€) å¤šçº¿ç¨‹çŠ¶æ€

### 1. çº¿ç¨‹çŠ¶æ€

>- åˆå§‹åŒ– ( `Init` ) : è¯¥çº¿ç¨‹æ­£åœ¨è¢«åˆ›å»º
>- å°±ç»ª ( `Ready` ) : è¯¥çº¿ç¨‹åœ¨å°±ç»ªåˆ—è¡¨ä¸­ , ç­‰å¾… CPU è°ƒåº¦
>- è¿è¡Œ ( `Running` ) : è¯¥çº¿ç¨‹æ­£åœ¨è¿è¡Œ
>- é˜»å¡ ( `Blocked` ) : è¯¥çº¿ç¨‹è¢«é˜»å¡æŒ‚èµ·
>   - `Blocked` çŠ¶æ€åŒ…æ‹¬ :  `pend` (é”ã€ äº‹ä»¶ã€ä¿¡å·é‡ç­‰é˜»å¡)ã€
>   `suspend`ï¼ˆä¸»åŠ¨ `pend`ï¼‰ã€`delay` (å»¶æ—¶é˜»å¡)ã€ `pendtime` (å› ä¸ºé”ã€äº‹ä»¶ã€ä¿¡å·é‡æ—¶é—´ç­‰è¶…æ—¶ç­‰å¾…)
>- é€€å‡º (`Exit`) : è¯¥çº¿ç¨‹è¿è¡Œç»“æŸ , ç­‰å¾…çˆ¶çº¿ç¨‹å›æ”¶å…¶æ§åˆ¶å—èµ„æº
>

<img src="./assets/image-20230801151448216.png" alt="image-20230801151448216" /> 

### 2. ç«äº‰çŠ¶æ€ (Race Condition) å’Œ ä¸´ç•ŒåŒº (Critical Section)

>- ç«äº‰çŠ¶æ€ (Race Condition) : å¤šçº¿ç¨‹åŒæ—¶è¯»å†™å…±äº«æ•°æ®
>- ä¸´ç•ŒåŒº (Critical Section) : è¯»å†™å…±äº«æ•°æ®çš„ä»£ç ç‰‡æ®µ
>- é¿å…ç«äº‰çŠ¶æ€ç­–ç•¥ , å¯¹ä¸´ç•ŒåŒºè¿›è¡Œä¿æŠ¤ , åŒæ—¶åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è¿›å…¥ä¸´ç•ŒåŒº

## (äºŒ) äº’æ–¥ä½“å’Œé” `mutex`

### 1. äº’æ–¥é”`mutex`

>- ä¸ç”¨é”çš„æƒ…å†µæ¼”ç¤º
>- æœŸæœ›è¾“å‡ºä¸€æ•´æ®µå†…å®¹
>- `lock()` å’Œ `try_lock()`
>- `unlock()`
>

[å®éªŒå‚è€ƒä»£ç ](/code/106thread_mutex)

#### (1) å®éªŒä¸€ : ä¸åŠ é”çš„æƒ…å†µ

<img src="./assets/image-20230801151505341.png" alt="image-20230801151505341" /> 

<img src="./assets/image-20230801151515592.png" alt="image-20230801151515592" /> 

>```tex
>ğŸ“èµ„æºç«äº‰å¯¼è‡´è¾“å‡ºæ··ä¹±
>```

#### (2) å®éªŒäºŒ : åŠ é”çš„æƒ…å†µ

<img src="./assets/image-20230801151552998.png" alt="image-20230801151552998" /> 

<img src="./assets/image-20230801151602146.png" alt="image-20230801151602146" /> 

#### (3) å®éªŒä¸‰ : ä¸é˜»å¡å°è¯•è·å–é”

<img src="./assets/image-20230801151609065.png" alt="image-20230801151609065" /> 

<img src="./assets/image-20230801151618260.png" alt="image-20230801151618260" /> 

<img src="./assets/image-20230801151624614.png" alt="image-20230801151624614" /> 

### 2. äº’æ–¥é”çš„å‘ : çº¿ç¨‹æŠ¢å ä¸åˆ°èµ„æº

<img src="./assets/image-20230801151630975.png" alt="image-20230801151630975" /> 

<img src="./assets/image-20230801151639439.png" alt="image-20230801151639439" /> 

>```
>âš ï¸è¡¥å……: é”æœ‰å¯èƒ½ä¼šè¢«åˆ«çš„çº¿ç¨‹è·å–åˆ°,ä½†æ˜¯ç”±äºçº¿ç¨‹æ— æ³•é¢„æµ‹,æ‰€ä»¥å½“å‰ç»“æœæ²¡æ˜¾ç¤ºåˆ°,å¹¶ä¸ä»£è¡¨ä¸ä¼šè¢«åˆ«çš„çº¿ç¨‹è·å–åˆ°ã€‚åœ¨ä¸Šé¢çš„ç»“æœæ˜¾ç¤º,ä¸´ç•Œèµ„æºè¢«2å·çº¿ç¨‹å ç”¨ç€ã€‚
>```

### 3.äº’æ–¥é”çš„å‘çš„è§£å†³åŠæ³• (å¹¶éå”¯ä¸€)

<img src="./assets/image-20230801151645167.png" alt="image-20230801151645167" /> 

<img src="./assets/image-20230801151653203.png" alt="image-20230801151653203" /> 

### 4. è¶…æ—¶é”åº”ç”¨ `timed_mutex` ( é¿å…é•¿æ—¶é—´æ­»é” )

>- å¯ä»¥è®°å½•é”è·å–æƒ…å†µ , å¤šæ¬¡è¶…æ—¶ , å¯ä»¥è®°å½•æ—¥å¿— , è·å–é”™è¯¯æƒ…å†µ
>

<img src="./assets/image-20230801151658618.png" alt="image-20230801151658618" /> 

<img src="./assets/image-20230801151704452.png" alt="image-20230801151704452" /> 

### 5. é€’å½’é”(å¯é‡å…¥) `recursive_mutex` å’Œ `recursive_timed_mutex` ç”¨äºä¸šåŠ¡ç»„åˆ

>- åŒä¸€ä¸ªçº¿ç¨‹ä¸­çš„åŒä¸€æŠŠé”å¯ä»¥é”å¤šæ¬¡ , é¿å…äº†ä¸€äº›ä¸å¿…è¦çš„æ­»é”
>- ç»„åˆä¸šåŠ¡ç”¨åˆ°åŒä¸€ä¸ªé”

#### (1) å®éªŒä¸€ : ä½¿ç”¨é€’å½’é”

<img src="./assets/image-20230801151711076.png" alt="image-20230801151711076" /> 

<img src="./assets/image-20230801151718167.png" alt="image-20230801151718167" /> 

#### (2) å®éªŒäºŒ : ä½¿ç”¨æ™®é€šé” , $\color{red}{ç¨‹åºç›´æ¥å®•æ‰}$

<img src="./assets/image-20230801151727409.png" alt="image-20230801151727409" /> 

<img src="./assets/image-20230801151734609.png" alt="image-20230801151734609" /> 

>```tex
>ğŸ“–åœ¨å·¥ç¨‹é¡¹ç›®ä¸­éš¾å…ä¼šå‡ºç°è°ƒç”¨å¤šæ¬¡é”,å¦‚æœä½¿ç”¨æ™®é€šé”,åˆæ²¡æœ‰è¿›è¡Œç‰¹æ®Šå¤„ç†çš„è¯,ç¨‹åºç›´æ¥å®•æ‰,åœ¨c++11ä»¥ä¸Šç‰ˆæœ¬æä¾›äº†é€’å½’é”,ä¸éœ€è¦ç¨‹åºå‘˜è‡ªå·±å»è¿›è¡Œç‰¹æ®Šå¤„ç†
>```

### 6. å…±äº«é” `shared_mutex`

>- c++14 å…±äº«è¶…æ—¶äº’æ–¥é” `shared_timed_mutex`
>- c++17 å…±äº«äº’æ–¥ `shared_mutex`
>- å¦‚æœåªæœ‰å†™æ—¶éœ€è¦äº’æ–¥ , è¯»å–æ—¶ä¸éœ€è¦ , ç”¨æ™®é€šçš„é”çš„è¯å¦‚ä½•åš?
>- æŒ‰ç…§å¦‚ä¸‹ä»£ç  , è¯»å–åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è¿›å…¥ , åœ¨å¾ˆå¤šä¸šåŠ¡åœºæ™¯ä¸­ , æ²¡æœ‰å……åˆ†åˆ©ç”¨ cpu èµ„æº
>

<img src="./assets/image-20230801151741917.png" alt="image-20230801151741917" /> 

>```
>ğŸ“–lock_shared()åˆç§°è¯»é”
>lock()åˆç§°å†™é”
>
>lock_shared()å¯ä»¥è¢«å¤šä¸ªçº¿ç¨‹è·å–åˆ°é”
>lock()åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹è·å–åˆ°é”,å…¶ä»–çº¿ç¨‹è°ƒç”¨lock()ä¼šè¢«é˜»å¡
>
>lock_shared()è·å–åˆ°é”ä¹‹å,æ‰€æœ‰çº¿ç¨‹çš„lock()è¢«é˜»å¡
>lock()è·å–åˆ°é”ä¹‹å,æ‰€æœ‰çº¿ç¨‹çš„lock_shared()å’Œlock()éƒ½ä¼šè¢«é˜»å¡
>
>```
>

[shared_mutexå…±äº«é”å‚è€ƒä»£ç ](/code/107thread_shared)

<img src="./assets/image-20230801151750131.png" alt="image-20230801151750131" /> 

<img src="./assets/image-20230801151756070.png" alt="image-20230801151756070" /> 

## (ä¸‰) åˆ©ç”¨æ ˆç‰¹æ€§è‡ªåŠ¨é‡Šæ”¾é”RAII

### 1. ä»€ä¹ˆæ˜¯RAII , æ‰‹åŠ¨ä»£ç å®ç°

>RAII (Resource Acquisition Is Initialization) C++ä¹‹çˆ¶ Bjarne Stroustrup æå‡º;
>ä½¿ç”¨å±€éƒ¨å¯¹è±¡æ¥ç®¡ç†èµ„æºçš„æŠ€æœ¯ç§°ä¸ºèµ„æºè·å–å³åˆå§‹åŒ–; å®ƒçš„ç”Ÿå‘½å‘¨æœŸæ˜¯ç”±æ“ä½œç³»ç»Ÿæ¥ç®¡ç†çš„ï¼Œ
>æ— éœ€äººå·¥ä»‹å…¥; èµ„æºçš„é”€æ¯å®¹æ˜“å¿˜è®°ï¼Œé€ æˆæ­»é”æˆ–å†…å­˜æ³„æ¼ã€‚

[RAIIå®éªŒå‚è€ƒä»£ç ](/code/108thread_RAII)

#### (1) å®éªŒä¸€ : æ‰‹åŠ¨å®ç° RAII ç®¡ç† mutex èµ„æº

<img src="./assets/image-20230801151802600.png" alt="image-20230801151802600" /> 

<img src="./assets/image-20230801151809000.png" alt="image-20230801151809000" /> 

### 2. c++11æ”¯æŒçš„RAIIç®¡ç†äº’æ–¥èµ„æº `lock_guard`

>- C++11 å®ç°ä¸¥æ ¼åŸºäºä½œç”¨åŸŸçš„äº’æ–¥ä½“æ‰€æœ‰æƒåŒ…è£…å™¨
>- `adopt_lock` C++11 ç±»å‹ä¸º `adopt_lock_t` , å‡è®¾è°ƒç”¨æ–¹å·²æ‹¥æœ‰äº’æ–¥çš„æ‰€æœ‰æƒ
>- é€šè¿‡ `{ }` æ§åˆ¶é”çš„ä¸´ç•ŒåŒº

#### (1) å®éªŒä¸€ : 

<img src="./assets/image-20230801151815947.png" alt="image-20230801151815947" /> 

<img src="./assets/image-20230801151821759.png" alt="image-20230801151821759" /> 

#### (2) å®éªŒäºŒ : åŒä¸€ä¸ªçº¿ç¨‹é”ä¸¤æ¬¡ , ç¨‹åºæŠ›å‡ºå¼‚å¸¸

<img src="./assets/image-20230801151827407.png" alt="image-20230801151827407" /> 

<img src="./assets/image-20230801151832999.png" alt="image-20230801151832999" /> 

#### (3) å®éªŒä¸‰ : æ­£å¸¸æƒ…å†µ (ç¨‹åºä¸ä¼šè¢«é”ä¸¤æ¬¡)

<img src="./assets/image-20230801151840268.png" alt="image-20230801151840268" /> 

<img src="./assets/image-20230801151859233.png" alt="image-20230801151859233" /> 

### 3. c++11å¼•å…¥`unique_lock` 

>- `unique_lock` C++11 å®ç° **$\color{red}{å¯ç§»åŠ¨}$** çš„äº’æ–¥ä½“æ‰€æœ‰æƒåŒ…è£…å™¨
>- æ”¯æŒ **$\color{red}{ä¸´æ—¶é‡Šæ”¾é”}$** `unlock()`
>- æ”¯æŒ `std::adopt_lock` **$\color{red}{(å·²ç»æ‹¥æœ‰é” , ä¸åŠ é” , å‡ºæ ˆåŒºä¼šé‡Šæ”¾)}$**
>- æ”¯æŒ `std::defer_lock` **$\color{red}{(å»¶åæ‹¥æœ‰ , ä¸åŠ é” , å‡ºæ ˆåŒºä¸é‡Šæ”¾)}$**
>- æ”¯æŒ `std::try_to_lock` å°è¯•è·å¾—äº’æ–¥çš„æ‰€æœ‰æƒè€Œ **$\color{red}{ä¸é˜»å¡}$**  , è·å–å¤±è´¥é€€å‡ºæ ˆåŒºä¸ä¼šé‡Šæ”¾ , é€šè¿‡ `owns_lock()` å‡½æ•°åˆ¤æ–­
>- æ”¯æŒè¶…æ—¶å‚æ•° , è¶…æ—¶ä¸æ‹¥æœ‰é”
>

>```c++
>/*unique_lockéƒ¨åˆ†æºç */
>
> unique_lock(unique_lock&& _Other) noexcept : _Pmtx(_Other._Pmtx), _Owns(_Other._Owns) {
>        _Other._Pmtx = nullptr;
>        _Other._Owns = false;
>    }
>
>unique_lock& operator=(unique_lock&& _Other) noexcept /* strengthened */ {
>        if (this != _STD addressof(_Other)) {
>            if (_Owns) {
>                _Pmtx->unlock();
>            }
>
>            _Pmtx        = _Other._Pmtx;
>            _Owns        = _Other._Owns;
>            _Other._Pmtx = nullptr;
>            _Other._Owns = false;
>        }
>        return *this;
>    }
>
>~unique_lock() noexcept {
>        if (_Owns) {
>            _Pmtx->unlock();
>        }
>    }
>
>unique_lock(const unique_lock&)            = delete;
>unique_lock& operator=(const unique_lock&) = delete;
>```
>

[RAII_unique_lockå‚è€ƒä»£ç ](/code/108thread_RAII)

<img src="./assets/image-20230801151909270.png" alt="image-20230801151909270" /> 

### 4. C++14å¼•å…¥`shared_lock` 

>- `shared_lock` C++14 å®ç° **$\color{red}{å¯ç§»åŠ¨}$** çš„ **$\color{SkyBlue}{å…±äº«äº’æ–¥ä½“}$** æ‰€æœ‰æƒå°è£…å™¨
>- ä¸`unique_lock` æœ‰ç€ç›¸ä¼¼åŠŸèƒ½
>

<img src="./assets/image-20230801151916569.png" alt="image-20230801151916569" /> 

### 5. C++17å¼•å…¥`scoped_lock` 

>`scoped_lock` C++17 ç”¨äºå¤šä¸ªäº’æ–¥ä½“çš„å…æ­»é” RAII å°è£…å™¨ ç±»ä¼¼ `lock()`
>

[lock()ä»‹ç»ä¸ä½¿ç”¨æ–¹æ³•](https://en.cppreference.com/w/cpp/thread/lock)

#### (1) å®éªŒä¸€ : æ¼”ç¤ºæ­»é”

<img src="./assets/image-20230801151924103.png" alt="image-20230801151924103" /> 

<img src="./assets/image-20230801151930654.png" alt="image-20230801151930654" /> 

#### (2) å®éªŒäºŒ : å¦‚ä½•é˜²æ­¢æ­»é”

<img src="./assets/image-20230801151935560.png" alt="image-20230801151935560" /> 

<img src="./assets/image-20230801151950700.png" alt="image-20230801151950700" /> 

6.ç»¼åˆæ¡ˆä¾‹ä¸€ : ä½¿ç”¨äº’æ–¥é” ( `mutex` ) + ( `list` )æ¨¡æ‹Ÿçº¿ç¨‹é€šä¿¡

>- å°è£…çº¿ç¨‹åŸºç±» `XThread` æ§åˆ¶çº¿ç¨‹å¯åŠ¨å’Œåœæ­¢
>- æ¨¡æ‹Ÿæ¶ˆæ¯æœåŠ¡å™¨çº¿ç¨‹ æ¥æ”¶å­—ç¬¦ä¸²æ¶ˆæ¯ï¼Œå¹¶æ¨¡æ‹Ÿå¤„ç†
>- é€šè¿‡ `unique_lock` å’Œ `mutex` äº’æ–¥è®¿é—® `list<string>` æ¶ˆæ¯é˜Ÿåˆ—
>- ä¸»çº¿ç¨‹å®šæ—¶å‘é€æ¶ˆæ¯ç»™å­çº¿ç¨‹
>

[æ¡ˆä¾‹ä¸€å‚è€ƒä»£ç ](/code/109thread_msg_server)

<img src="./assets/image-20230801152000614.png" alt="image-20230801152000614" /> 

<img src="./assets/image-20230801152010152.png" alt="image-20230801152010152" /> 

## (å››) æ¡ä»¶å˜é‡

### 1. ç”Ÿäº§è€… - æ¶ˆè´¹è€…æ¨¡å‹

>- ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…å…±äº«èµ„æºå˜é‡( `list` é˜Ÿåˆ—)
>- ç”Ÿäº§è€…ç”Ÿäº§ä¸€ä¸ªäº§å“ , é€šçŸ¥æ¶ˆè´¹è€…æ¶ˆè´¹
>- æ¶ˆè´¹è€…é˜»å¡ç­‰å¾…ä¿¡å· - è·å–ä¿¡å·åæ¶ˆè´¹äº§å“ (å–å‡º `list` é˜Ÿåˆ—ä¸­æ•°æ®)

#### (1) æ”¹å˜å…±äº«å˜é‡çš„çº¿ç¨‹æ­¥éª¤ (å†™çº¿ç¨‹)

>1. å‡†å¤‡å¥½ä¿¡å·é‡ `std::condition_variable cv;`
>2. è·å¾— `std::mutex` (å¸¸é€šè¿‡ `std::unique_lock` ) `unique_lock lock(mux);`
>3. åœ¨è·å–é”æ—¶è¿›è¡Œä¿®æ”¹ `msgs_.push_back(data);`
>4. é‡Šæ”¾é”å¹¶é€šçŸ¥è¯»å–çº¿ç¨‹
>
>```c++
>lock.unlock();
>cv.notify_one(); //é€šçŸ¥ä¸€ä¸ªç­‰å¾…ä¿¡å·çº¿ç¨‹
>cv.notify_all(); //é€šçŸ¥æ‰€æœ‰ç­‰å¾…ä¿¡å·çº¿ç¨‹
>```

#### (2) ç­‰å¾… ä¿¡å· è¯»å– å…±äº«å˜é‡ çš„çº¿ç¨‹æ­¥éª¤ (è¯»çº¿ç¨‹)

>1. è·å¾—ä¸æ”¹å˜å…±äº«å˜é‡çº¿ç¨‹å…±åŒçš„ `mutex`
>
>```c++
>unique_lock lock(mux);
>```
>
>2. `wait()` ç­‰å¾…ä¿¡å·é€šçŸ¥
>    1. æ— lambdaè¡¨è¾¾å¼
>    2. lambdaè¡¨è¾¾å¼ `cv.wait(lock,[]{ return !msgs_.empty()})`;
>    3. åªåœ¨ `std::unique_lock<std::mutex>` ä¸Šå·¥ä½œçš„ `std::condition_variable` 
>
>```c++
>//è§£é”lock,å¹¶é˜»å¡ç­‰å¾… notify_one notify_all é€šçŸ¥
>cv.wait(lock);	/*æ— lambdaè¡¨è¾¾å¼*/
>//æ¥æ”¶åˆ°é€šçŸ¥ä¼šå†æ¬¡è·å–é”æ ‡æ³¨ï¼Œ ä¹Ÿå°±æ˜¯è¯´å¦‚æœæ­¤æ—¶muxèµ„æºè¢«å ç”¨ï¼Œ waitå‡½æ•°ä¼šé˜»å¡
>msgs_.front();
>//å¤„ç†æ•°æ®
>msgs_.pop_front();
>```
>
>```c++
>void wait(unique_lock<mutex>& _Lck) 
>{ 
>    // wait for signal// Nothing to do to comply with LWGâ€2135 because std::mutex lock/unlock arenothrow
>    _Check_C_return(_Cnd_wait(_Mycnd(), _Lck.mutex()â€>_Mymtx()));
>} 
>
>template <class _Predicate>
>void wait(unique_lock<mutex>& _Lck, _Predicate _Pred) 
>{
>     // wait for signal and testpredicate
>     while (!_Pred()){ 
>         wait(_Lck);
>     }
> }
>```
>

[std::condition_variableå®éªŒå‚è€ƒä»£ç ](/code/110condition_variable/110condition_variable.cpp)

#### (3) å®éªŒä¸€ : æ—  lambda `wait()`

<img src="./assets/image-20230801152018315.png" alt="image-20230801152018315" /> 

<img src="./assets/image-20230801152023912.png" alt="image-20230801152023912" /> 

#### (4) å®éªŒäºŒ : å¸¦lambda `wait()`

<img src="./assets/image-20230801152031323.png" alt="image-20230801152031323" /> 

<img src="./assets/image-20230801152036977.png" alt="image-20230801152036977" /> 

### 2.ç»¼åˆæ¡ˆä¾‹äºŒ : åœ¨ç»¼åˆå®ä¾‹ä¸€ä¸ŠåŠ ä¸Š `condition_variable` 

[ç»¼åˆæ¡ˆä¾‹äºŒå‚è€ƒä»£ç ](/code/111thread_msg_server_condition)

#### (1)å®éªŒä¸€ : ä¸å¸¦ lambdaçš„ `wait()`

<img src="./assets/image-20230801152043041.png" alt="image-20230801152043041" /> 

<img src="./assets/image-20230801152048838.png" alt="image-20230801152048838" /> 

<img src="./assets/image-20230801152054226.png" alt="image-20230801152054226" /> 

>```
>ğŸ“–å¢åŠ condition_variableå,çº¿ç¨‹æ˜¯æ— æ³•é€€å‡ºçš„,ä¼šè¢«wait()å‡½æ•°é˜»å¡
>```

#### (2)å®éªŒäºŒ : å¸¦ lambda çš„ `wait()` , å¹¶è§£å†³çº¿ç¨‹æ— æ³•é€€å‡ºé—®é¢˜

<img src="./assets/image-20230801152100131.png" alt="image-20230801152100131" /> 

>```tex
>âŒä¸å»ºè®®åŸºç±»çš„æˆå‘˜å˜é‡è®©æ´¾ç”Ÿç±»å¯ä»¥ç›´æ¥æ“ä½œ,æ­¤å¤„ä»…ä»…æ˜¯ä¸ºäº†å®éªŒç®€å•
>```
>

<img src="./assets/image-20230801152106296.png" alt="image-20230801152106296" /> 

<img src="./assets/image-20230801152113359.png" alt="image-20230801152113359" /> 

<img src="./assets/image-20230801152118644.png" alt="image-20230801152118644" /> 

## (äº”) çº¿ç¨‹å¼‚æ­¥å’Œé€šä¿¡

### 1. `promise` & `future`

>- `std::promise` ç”¨äºå¼‚æ­¥ä¼ è¾“å˜é‡
>   - `std::promise` æä¾›å­˜å‚¨å¼‚æ­¥é€šä¿¡çš„å€¼ , å†é€šè¿‡å…¶å¯¹è±¡åˆ›å»ºçš„ `std::future` å¼‚æ­¥è·å¾—ç»“æœ
>   - `std::promise` åªèƒ½ **$\color{red}{ä½¿ç”¨ä¸€æ¬¡ (ä¸€ä¸ªå¯¹è±¡åªèƒ½ç”¨ä¸€æ¬¡)}$** , `void std::promise::set_value(_Ty&& _Val)` è®¾ç½®ä¼ é€’å€¼ , **$\color{red}{åªèƒ½è°ƒç”¨ä¸€æ¬¡}$**
>
>- `std::future` æä¾›è®¿é—®å¼‚æ­¥æ“ä½œç»“æœçš„æœºåˆ¶
>   - `std::future::get()` é˜»å¡ç­‰å¾… `promise::set_value(_Ty&& _Val)` çš„å€¼
>

[std::promise & std::futureå®éªŒä»£ç ](/code/112promise_future)

<img src="./assets/image-20230801152125235.png" alt="image-20230801152125235" /> 

<img src="./assets/image-20230801152131627.png" alt="image-20230801152131627" /> 

### 2. `packaged_task` å¼‚æ­¥è°ƒç”¨å‡½æ•°æ‰“åŒ…

>- `packaged_task` åŒ…è£…å‡½æ•°ä¸ºä¸€ä¸ªå¯¹è±¡ , ç”¨äºå¼‚æ­¥è°ƒç”¨ , å…¶è¿”å›å€¼èƒ½é€šè¿‡ `std::future` å¯¹è±¡è®¿é—®
>- ä¸bindçš„åŒºåˆ« , å¯å¼‚æ­¥è°ƒç”¨ , **$\color{red}{å‡½æ•°è®¿é—®å’Œè·å–è¿”å›å€¼åˆ†å¼€}$** è°ƒç”¨
>- æ”¯æŒå…¨å±€å‡½æ•° , æˆå‘˜å‡½æ•° , ä»¿å‡½æ•° , lambdaè¡¨è¾¾å¼
>- æ”¯æŒå•çº¿ç¨‹å’Œå¤šçº¿ç¨‹ä½¿ç”¨
>

[packaged_taskå®éªŒå‚è€ƒä»£ç ](/code/113packaged_task)

#### (1) å®éªŒä¸€ : å•çº¿ç¨‹è°ƒç”¨

<img src="./assets/image-20230801152137940.png" alt="image-20230801152137940" /> 

<img src="./assets/image-20230801152145766.png" alt="image-20230801152145766" /> 

#### (2) å®éªŒäºŒ : å¤šçº¿ç¨‹è°ƒç”¨

<img src="./assets/image-20230801152152674.png" alt="image-20230801152152674" /> 

<img src="./assets/image-20230801152157089.png" alt="image-20230801152157089" /> 

>```
>â“get()å‡½æ•°ä¼šé˜»å¡,æœ‰æ²¡æœ‰åŠæ³•ä¸è®©é˜»å¡?
>ç­”æ¡ˆæ˜¯æœ‰çš„
>```
>

<img src="./assets/image-20230801152203746.png" alt="image-20230801152203746" /> 

<img src="./assets/image-20230801152211124.png" alt="image-20230801152211124" /> 

<img src="./assets/image-20230801152219460.png" alt="image-20230801152219460" /> 

<img src="./assets/image-20230801152228494.png" alt="image-20230801152228494" /> 

### 3. `async` åˆ›å»ºå¼‚æ­¥çº¿ç¨‹

>- C++11 å¼‚æ­¥è¿è¡Œä¸€ä¸ªå‡½æ•° , å¹¶è¿”å›ä¿æœ‰å…¶ç»“æœçš„ `std::future`
>   - `launch::deferred` å»¶è¿Ÿæ‰§è¡Œåœ¨è°ƒç”¨ `wait()` å’Œ `get()` æ—¶ , è°ƒç”¨å‡½æ•°ä»£ç 
>   - `launch::async` åˆ›å»ºçº¿ç¨‹ (é»˜è®¤è¡Œä¸º)
>   - è¿”å›çš„çº¿ç¨‹å‡½æ•°çš„è¿”å›å€¼ç±»å‹çš„ `std::future<int>`  ( `std::future<"return type">` )
>   - `re.get()` è·å–ç»“æœ , ä¼šé˜»å¡ç­‰å¾…
>

[asyncåˆ›å»ºå¼‚æ­¥çº¿ç¨‹å®éªŒå‚è€ƒä»£ç ](/code/114async_thread)

#### (1) å®éªŒä¸€ : ä¸åˆ›å»ºçº¿ç¨‹å¯åŠ¨å¼‚æ­¥ä»»åŠ¡

<img src="./assets/image-20230801152234836.png" alt="image-20230801152234836" /> 

<img src="./assets/image-20230801152241615.png" alt="image-20230801152241615" /> 

#### (2) å®éªŒäºŒ : åˆ›å»ºå¼‚æ­¥çº¿ç¨‹

<img src="./assets/image-20230801152248556.png" alt="image-20230801152248556" /> 

<img src="./assets/image-20230801152255112.png" alt="image-20230801152255112" /> 

